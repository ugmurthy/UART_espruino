
<!doctype html>
<html lang="en">
 <head>
  <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

 </head>
 <body>
  <script src="https://www.espruino.com/js/uart.js"></script>
  <script>
  
var record = ""
var OUT=true;
function chunks2json(d) {
    const END="}";
    const START="{"
    var idx_start;
    var idx_end;
    var res = ""
    idx_start = d.search(START);
    idx_end = d.search(END);

    //console.log("proc ", OUT, idx_start, idx_end, d);
    switch (OUT) {
        case true:
            //console.log("Case :",OUT);
            if (idx_start == -1) {
                res = ""
            }
            if (idx_start > -1 && idx_end > 0) {
                OUT = false;
                console.log(OUT);
                res = d.substring(idx_start, idx_end+1);
            }
            if (idx_start > -1) {
                OUT = false;
                res = d.substring(idx_start);
            }
            break;

        case false:
            //console.log("Case :",OUT);

            if (idx_end == -1) {
                OUT = false;
                res = d;
            }
            if (idx_end > -1) {
                OUT = true;
                res = d.substring(0, idx_end+1);
            }
            break
    }
    //console.log("proc returns ", res);
    return res;
}

   
  UART.connect(function(connection) {
    
    if (!connection) throw "Error!";
    
    document.getElementById("status").innerHTML = "Connected";
    connection.on('data', function(d) { 
          record = record + chunks2json(d);
          if (OUT) {
              var S = {};
               if (record) { // ensure non empty record
                 S = JSON.parse(record);
                 if (S) { // ensure we have a non empty json
                   console.log(S.sample_count,S.rep_count);
                   document.getElementById("count").innerHTML = S.rep_count; 
                   document.getElementById("result").innerHTML = record +"<BR>"+ document.getElementById("result").innerHTML; 
                 }
               }
          record="";
          OUT=true;
          }
    });
    connection.on('close', function() { document.getElementById("status").innerHTML = 'Connection Closed';});
  });

  function show_header() {
      var jsline = ['S.button++','S.button = S.button % 4','console.log(S)'];
   
      for (let i=0;i<jsline.length; i++) {
          UART.write(jsline[i]+';\n');"
      }
  }
  </script>
   <div class="container-sm text-center">
       
       <button type="button" class="btn btn-primary" onclick="UART.write('LED1.set();\n');">Headers</button>
       <button type="button" class="btn btn-secondary">Secondary</button>
       <button type="button" class="btn btn-success">Success</button>
       <button type="button" class="btn btn-info">Info</button>
       <button type="button" class="btn btn-warning">Warning</button>
       <button type="button" class="btn btn-danger">Danger</button>
       <button type="button" class="btn btn-dark">Dark</button>
       <button type="button" class="btn btn-light">Light</button>
       <button type="button" class="btn btn-link">Link</button>
  </div>
    <div class = "container-sm text-center">   
    <p>
           <span id="status"></span>
       <p>
       <span id="count" style="color:blue;font-size:600%"></span>
       <hr>
       <span id="result" ></span>
       <hr>
       <p>
       <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
  </div>  
 </body>
</html>
